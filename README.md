# VPN-RDP-WEB
VPN-RDP-WEB



--- Database üzerinde aşağıdaki tablonun eklenmesi
```
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[CONNECTIONS](
	[SYS_NO] [int] IDENTITY(1,1) NOT NULL,
	[KURUM] [nvarchar](100) NULL,
	[TIP] [nvarchar](50) NOT NULL,
	[IP] [nvarchar](50) NOT NULL,
	[PORT] [int] NOT NULL,
	[KULLANICI] [nvarchar](50) NULL,
	[SIFRE] [nvarchar](255) NULL,
	[NOTLAR] [nvarchar](500) NOT NULL,
	[KAYIT_ANI] [datetime2](7) NULL,
 CONSTRAINT [PK__CONNECTI__5B0D54D8104B79DB] PRIMARY KEY CLUSTERED 
(
	[SYS_NO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[CONNECTIONS] ADD  CONSTRAINT [DF_CONNECTIONS_PORT]  DEFAULT ((0)) FOR [PORT]
GO

ALTER TABLE [dbo].[CONNECTIONS] ADD  CONSTRAINT [DF__CONNECTIO__KAYIT__1233C24D]  DEFAULT (getdate()) FOR [KAYIT_ANI]
GO
```


Tablo üzerinde yapılan değişiklikleri başka bir tabloda loglamak amacıyla tutmak için AUD adı altında tablo
```
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[AudCONNECTIONS](
	[AUDIT_SYS_NO] [int] IDENTITY(1,1) NOT NULL,
	[AUDIT_TIME_STAMP] [timestamp] NOT NULL,
	[AUDIT_TARIH] [datetime2](3) NOT NULL,
	[AUDIT_KULLANICI] [smallint] NOT NULL,
	[AUDIT_ISLEM] [char](1) NOT NULL,
	[SYS_NO] [int] NOT NULL,
	[KURUM] [nvarchar](100) NULL,
	[TIP] [nvarchar](50) NOT NULL,
	[IP] [nvarchar](50) NOT NULL,
	[PORT] [int] NOT NULL,
	[KULLANICI] [nvarchar](50) NULL,
	[SIFRE] [nvarchar](255) NULL,
	[NOTLAR] [nvarchar](500) NOT NULL,
	[KAYIT_ANI] [datetime2](7) NULL,
 CONSTRAINT [PK_AudCONNECTIONS] PRIMARY KEY CLUSTERED 
(
	[AUDIT_SYS_NO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[AudCONNECTIONS] ADD  CONSTRAINT [DF_AudCONNECTIONS_Tarih]  DEFAULT (sysdatetime()) FOR [AUDIT_TARIH]
GO

ALTER TABLE [dbo].[AudCONNECTIONS] ADD  CONSTRAINT [DF_AudCONNECTIONS_Kullanici]  DEFAULT ([dbo].[FN_USER_ID]()) FOR [AUDIT_KULLANICI]
GO
```


Değişiklik yapılan işlemleri daha detaylı görebilmek adına VIEW
```
ALTER VIEW AudCONNECTIONS_VIEW AS   
SELECT *,  
  CASE  
  WHEN AUDIT_ISLEM = 'S' THEN cast('Sil'as varchar(512))  
  ELSE ''  
   +CASE WHEN [SYS_NO]<> [N_SYS_NO] THEN ',SYS_NO' ELSE '' END  
   +CASE WHEN [KURUM]<> [N_KURUM] THEN ',KURUM' ELSE '' END  
   +CASE WHEN [TIP]<> [N_TIP] THEN ',TIP' ELSE '' END  
   +CASE WHEN [IP]<> [N_IP] THEN ',IP' ELSE '' END  
   +CASE WHEN [PORT]<> [N_PORT] THEN ',PORT' ELSE '' END  
   +CASE WHEN [KULLANICI]<> [N_KULLANICI] THEN ',KULLANICI' ELSE '' END  
   +CASE WHEN [SIFRE]<> [N_SIFRE] THEN ',SIFRE' ELSE '' END  
   +CASE WHEN [NOTLAR]<> [N_NOTLAR] THEN ',NOTLAR' ELSE '' END  
   +CASE WHEN [KAYIT_ANI]<> [N_KAYIT_ANI] THEN ',KAYIT_ANI' ELSE '' END  
   + ','   
 END AS DEGISEN_KOLONLAR  
FROM   
(  
 SELECT  
 AP.AUDIT_SYS_NO,  
 AP.AUDIT_TIME_STAMP,  
 AP.AUDIT_TARIH,  
 AP.AUDIT_KULLANICI,  
 AP.AUDIT_ISLEM,  
 dbo.FN_USER_NAME_PARAMETRE(AP.AUDIT_KULLANICI) AS AUDIT_KULLANICI_ACIKLAMA  
   
 ,AP.[SYS_NO] AS [SYS_NO]  
 ,ISNULL( AN.[SYS_NO], M.[SYS_NO]) AS [N_SYS_NO]  
 ,AP.[KURUM] AS [KURUM]  
 ,ISNULL( AN.[KURUM], M.[KURUM]) AS [N_KURUM]  
 ,AP.[TIP] AS [TIP]  
 ,ISNULL( AN.[TIP], M.[TIP]) AS [N_TIP]  
 ,AP.[IP] AS [IP]  
 ,ISNULL( AN.[IP], M.[IP]) AS [N_IP]  
 ,AP.[PORT] AS [PORT]  
 ,ISNULL( AN.[PORT], M.[PORT]) AS [N_PORT]  
 ,AP.[KULLANICI] AS [KULLANICI]  
 ,ISNULL( AN.[KULLANICI], M.[KULLANICI]) AS [N_KULLANICI]  
 ,AP.[SIFRE] AS [SIFRE]  
 ,ISNULL( AN.[SIFRE], M.[SIFRE]) AS [N_SIFRE]  
 ,AP.[NOTLAR] AS [NOTLAR]  
 ,ISNULL( AN.[NOTLAR], M.[NOTLAR]) AS [N_NOTLAR]  
 ,AP.[KAYIT_ANI] AS [KAYIT_ANI]  
 ,ISNULL( AN.[KAYIT_ANI], M.[KAYIT_ANI]) AS [N_KAYIT_ANI]  
   
  FROM AudCONNECTIONS AP  
 OUTER APPLY  
 (  
  SELECT TOP 1 AN.*  
  FROM AudCONNECTIONS AN WITH(NOLOCK, INDEX(IX_AudCONNECTIONS_PKEY))  
  WHERE AP.[SYS_NO] = AN.[SYS_NO]  
  AND AN.AUDIT_SYS_NO > AP.AUDIT_SYS_NO  
  ORDER BY AN.AUDIT_SYS_NO  
 ) AN  
  
 LEFT OUTER JOIN CONNECTIONS M WITH(NOLOCK) ON AN.AUDIT_SYS_NO IS NULL AND AP.[SYS_NO] = M.[SYS_NO]   
) B  
```


Tablo üzerinde yapılan değişiklikleri anlık olarak AUD tablosuna basmak için trigger 
```
ALTER TRIGGER [dbo].[TRGAuditCONNECTIONS] ON dbo.CONNECTIONS
FOR UPDATE,DELETE  
AS                                                 
	SET NOCOUNT ON  
	IF NOT EXISTS(SELECT * FROM deleted)  RETURN

	DECLARE @Islem char(1), @AUDIT_KULLANICI INT = dbo.FN_USER_ID()
	IF EXISTS(SELECT * FROM inserted) 
		SET @Islem='G' ELSE SET @Islem='S' 
	INSERT INTO AudCONNECTIONS
		(
		AUDIT_ISLEM,AUDIT_KULLANICI
		,[SYS_NO]
		,[KURUM]
		,[TIP]
		,[IP]
		,[PORT]
		,[KULLANICI]
		,[SIFRE]
		,[NOTLAR]
		,[KAYIT_ANI]
		)
		select 
		@Islem,@AUDIT_KULLANICI
		,[SYS_NO]
		,[KURUM]
		,[TIP]
		,[IP]
		,[PORT]
		,[KULLANICI]
		,[SIFRE]
		,[NOTLAR]
		,[KAYIT_ANI]
	FROM deleted 
	IF @Islem='G'
	BEGIN   
	
			
			UPDATE CONNECTIONS Set KAYIT_ANI=SYSDATETIME()             
			FROM inserted ins 
			INNER JOIN CONNECTIONS T     ON
				T.[SYS_NO] = ins.[SYS_NO]
	END
RETURN
```






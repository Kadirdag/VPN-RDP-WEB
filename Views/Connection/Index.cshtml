@model IEnumerable<VPN_RDP_Manager_Web.Models.Connection>

<style>
    /* Tüm tablo satırlarının padding’i küçültüldü */
    table#connectionTable tbody tr td, 
    table#connectionTable tbody tr th {
        padding: 0.25rem 0.5rem; /* üst-alt 0.25rem, sağ-sol 0.5rem */
        vertical-align: middle;
    }

    /* Hover efekti */
    table#connectionTable tbody tr:hover {
        background-color: #ffe5b4; /* hafif turuncu */
    }

    /* Zebra striping */
    table#connectionTable tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    /* Şifre input ve butonlar daha kompakt */
    .pwd-container input {
        height: 28px;
        font-size: 0.9rem;
    }
    .pwd-container button {
        padding: 2px 6px;
        font-size: 0.8rem;
    }

    .list-group-item.active-kurum {
        background-color: #007bff; /* Bootstrap primary rengi */
        color: white;
        font-weight: bold;
        border-color: #007bff;
    }

        .list-group-item.active-kurum a {
            color: white !important; /* Link rengini beyaz yap */
        }

    .kurum-separator {
        border-top: 1px solid #ccc;
        margin-top: 5px;
        margin-bottom: 5px;
    }
    /* Durum Topu Tasarımı */
.status-dot {
    height: 12px;
    width: 12px;
    background-color: #bbb; /* Varsayılan gri (kontrol ediliyor) */
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    box-shadow: 0 0 2px rgba(0,0,0,0.2);
}

/* Aktif (Online) Durum - Parlayan Yeşil */
.status-online {
    background-color: #28a745;
    box-shadow: 0 0 5px #28a745;
}

/* Pasif (Offline) Durum - Kırmızı */
.status-offline {
    background-color: #dc3545;
}

/* Kontrol Ediliyor (Animasyonlu Sarı) */
.status-checking {
    background-color: #ffc107;
    animation: blink 1s infinite;
}

    @@keyframes blink {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        100% {
            opacity: 1;
        }
    }

    /* Diğer CSS kodların aynen kalabilir */
    .status-checking {
        background-color: #ffc107;
        animation: blink 1s infinite;
    }

</style>


<div class="bg-light p-3" style="width:220px; height:100%; position:fixed; left:0; top:0; overflow-y:auto; border-right: 1px solid #ddd;">
    <h5 class="text-start mb-3">
        <i class="fas fa-building me-2"></i> **Kurumlar**
    </h5>

    <ul class="list-group list-group-flush">
        <li class="list-group-item text-start active-kurum" data-kurum-id="">
            <a href="#" onclick="filterByKurum('')">Tümü</a>
        </li>
    </ul>

    <div class="kurum-separator"></div>

    <ul class="list-group list-group-flush" id="kurum-listesi">
        @foreach (var kurum in Model.Select(m => m.KURUM).Distinct().OrderBy(k => k))
        {
            <li class="list-group-item text-start" data-kurum-id="@kurum">
                <a href="#" onclick="filterByKurum('@kurum')">@kurum</a>
            </li>
        }
    </ul>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <!-- Sağ Taraf Tablo -->
    <div class="flex-grow-1 p-3" style="margin-left:150; height:100%;">
        <h2>Optimus Yazılım VPN-RDP Bilgileri</h2>
        <a class="btn btn-primary mb-3" href="@Url.Action("Create")">Yeni Bağlantı Ekle</a>

    <input type="text" id="quickSearch" class="form-control w-25"
           placeholder="Tabloda Ara (IP, Not, Kullanıcı...)"
           onkeyup="filterTable()">
    </div>

        <table class="table table-bordered w-100" id="connectionTable">
            <thead class="table-dark">
                <tr>
                    <th>SYS_NO</th>
                    <th>KURUM</th>
                    <th style="min-width:200px;">NOTLAR</th>
                    <th style="min-width:200px;">IPX</th>
                    <th>PORT</th>
                    <th>KULLANICI</th>
                    <th style="min-width:220px;">ŞİFRE</th>
                    <th>TIP</th>
                    <th>KAYIT_ANI</th>
                    <th style="min-width:150px;">BAĞLANTI</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr data-kurum="@item.KURUM">
                        <td>@item.SYS_NO</td>
                        <td>@item.KURUM</td>
                        <td>@item.NOTLAR</td>
                        <td>
                            <div class="d-flex ip-container">
                                <input class="form-control me-1" id="ip_@item.SYS_NO" value="@item.IP" readonly />
                                <button type="button" class="btn btn-info btn-sm" onclick="copyIp(@item.SYS_NO)">📋</button>
                            </div>
                        </td>
                        <td>@item.PORT</td>
                        <td>
                            <div class="d-flex user-container">
                                <input class="form-control me-1" id="user_@item.SYS_NO" value="@item.KULLANICI" readonly />
                                <button type="button" class="btn btn-info btn-sm" onclick="copyUser(@item.SYS_NO)">📋</button>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex pwd-container">
                                <input type="password" class="form-control me-1" id="pwd_@item.SYS_NO" value="@item.SIFRE" readonly />
                                <button type="button" class="btn btn-secondary me-1 btn-sm" onclick="togglePassword(@item.SYS_NO)">👁</button>
                                <button type="button" class="btn btn-info btn-sm" onclick="copyPassword(@item.SYS_NO)">📋</button>
                            </div>
                        </td>
                        <td>@item.TIP</td>
                        <td>@item.KAYIT_ANI</td>

                        <td style="text-align:center; vertical-align:middle;">
                            <div class="d-flex align-items-center justify-content-center">

                                <span class="status-dot status-checking me-2"
                                      id="dot_@item.SYS_NO"
                                      data-ip="@item.IP"
                                      style="cursor: help;">
                                </span>

                                <a href="optimus://@item.IP$$@Uri.EscapeDataString(item.KULLANICI)$$@Uri.EscapeDataString(item.SIFRE)"
                                   class="btn btn-outline-success btn-sm py-0 px-2"
                                   style="font-size: 0.8rem; height: 24px; line-height: 22px; font-weight:bold;"
                                   title="Otomatik Giriş">
                                    <i class="fas fa-magic"></i> Giriş Yap
                                </a>

                            </div>
                        </td>

                        <td>
                            <div class="btn-group">
                                <a asp-action="Edit" asp-route-id="@item.SYS_NO" class="btn btn-warning btn-sm">✏️ Düzelt</a>
                                <form asp-action="Delete" asp-route-id="@item.SYS_NO" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-danger btn-sm">🗑️ Sil</button>
                                </form>
                            </div>
                        </td>

                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    function togglePassword(id) {
        var input = document.getElementById("pwd_" + id);
        input.type = (input.type === "password") ? "text" : "password";
    }

    function filterTable() {
        // Kurum filtresi aktifse iptal etmiyoruz, sadece görüntülenen satırlarda arama yapıyoruz.
        var input = document.getElementById("quickSearch");
        var filter = input.value.toUpperCase();
        var table = document.getElementById("connectionTable");
        var tr = table.getElementsByTagName("tr");

        // Aktif kurum filtresini bul (eğer varsa)
        var activeKurum = document.querySelector('.list-group-item.active-kurum');
        var currentKurumFilter = activeKurum ? activeKurum.getAttribute('data-kurum-id') : "";

        // Başlık satırını atlamak için i = 1'den başlat
        for (i = 1; i < tr.length; i++) {
            var row = tr[i];
            var kurumData = row.getAttribute("data-kurum");
            var rowText = row.innerText.toUpperCase(); // Tüm satırın içeriğini al

            var kurumMatch = (currentKurumFilter === "" || kurumData === currentKurumFilter);
            var searchMatch = (rowText.indexOf(filter) > -1);

            if (kurumMatch && searchMatch) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        }
    }

    function showCopyFeedback(elementId, message = "Kopyalandı!") {
        var element = document.getElementById(elementId);

        // Kopyalama mesajı için geçici bir span oluştur
        var feedback = document.createElement("span");
        feedback.className = "text-success ms-2 fw-bold position-absolute";
        feedback.style.fontSize = "0.75rem";
        feedback.style.whiteSpace = "nowrap";
        feedback.style.right = "0";
        feedback.textContent = message;

        // Kapsayıcıya göre pozisyon ayarla
        element.parentElement.style.position = "relative";
        element.parentElement.appendChild(feedback);

        // Bir süre sonra mesajı kaldır
        setTimeout(() => {
            feedback.remove();
        }, 1500);
    }

    function copyPassword(id) {
        var input = document.getElementById("pwd_" + id);
        // Eski tarayıcı desteği için, input.type = "text" yapıp kopyala
        input.type = "text";
        input.select();
        input.setSelectionRange(0, 99999);
        document.execCommand("copy");
        input.type = "password";
        showCopyFeedback("pwd_" + id); // Geri bildirim göster
    }

    function copyUser(id) {
        var copyText = document.getElementById("user_" + id);
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        showCopyFeedback("user_" + id); // Geri bildirim göster
    }

    function copyIp(id) {
        var copyText = document.getElementById("ip_" + id);
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        showCopyFeedback("ip_" + id); // Geri bildirim göster
    }

    function filterByKurum(kurum) {
        // ... (Vurgulama kısmı aynı kalmalı) ...

        var listItems = document.querySelectorAll('.list-group-item');
        listItems.forEach(item => {
            item.classList.remove('active-kurum');
        });

        var selectedItem = document.querySelector(`[data-kurum-id='${kurum}']`);
        if (selectedItem) {
            selectedItem.classList.add('active-kurum');
        }

        // Kurum filtresi uygulandıktan sonra, mevcut arama filtresini de uygula
        filterTable();
    }

    document.addEventListener("DOMContentLoaded", function () {
        // 1. Sayfadaki "status-dot" sınıfına sahip TÜM elementleri bul
        const dots = document.querySelectorAll('.status-dot');

        runChecks();

        setInterval(runChecks, 10000);

        // 2. Hepsini tek tek döngüye sok
        dots.forEach(dot => {
            const ip = dot.getAttribute('data-ip'); // HTML'den IP'yi oku
            const elementId = dot.id;               // HTML'den ID'yi al

            // IP varsa kontrole gönder
            if (ip && ip.trim() !== "") {
                checkServerStatus(ip, elementId);
            } else {
                // IP yoksa gri yap bırak
                dot.classList.remove("status-checking");
                dot.style.backgroundColor = "#ccc";
            }
        });
    });

    function runChecks() {
        const dots = document.querySelectorAll('.status-dot');

        dots.forEach(dot => {
            const ip = dot.getAttribute('data-ip');
            const elementId = dot.id;

            if (ip && ip.trim() !== "") {
                // Eğer zaten kontrol ediliyorsa (sarıysa) tekrar istek atma
                // if (!dot.classList.contains("status-checking")) {
                checkServerStatus(ip, elementId);
                // }
            } else {
                dot.classList.remove("status-checking");
                dot.style.backgroundColor = "#ccc";
            }
        });
    }

    function checkServerStatus(ip, elementId) {
        // DİKKAT: Controller adın "Connection" ise adres "/Connection/..." olmalı.
        // Eğer "/api/" kullanmıyorsan burayı düzelttim:
        fetch('/Connection/CheckServerStatus?ip=' + ip + '&t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                const dot = document.getElementById(elementId);
                dot.classList.remove("status-checking"); // Yanıp sönmeyi durdur


                dot.classList.remove("status-online");
                dot.classList.remove("status-offline");

                if (data.isOnline) {
                    dot.classList.add("status-online"); // YEŞİL
                    dot.title = "Sunucu Aktif (3389 Portu Açık)";
                } else {
                    dot.classList.add("status-offline"); // KIRMIZI
                    dot.title = "Erişim Yok / Kapalı";
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                const dot = document.getElementById(elementId);
                if (dot) {
                    dot.classList.remove("status-checking");
                    dot.classList.remove("status-online"); // Yeşili sil
                    dot.classList.add("status-offline");   // Kırmızı yap
                }
            });
    }
</script>
